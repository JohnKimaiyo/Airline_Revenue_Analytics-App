<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Airline Revenue Management Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { box-sizing: border-box; }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 30px 40px;
            background: #f0f2f5;
            color: #222;
        }

        h2 {
            margin-bottom: 20px;
            color: #1a1a2e;
        }

        .controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 24px;
        }

        select, button {
            padding: 9px 14px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }

        button {
            background: #1a1a2e;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover { background: #16213e; }

        .kpi-row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }

        .kpi-card {
            flex: 1;
            min-width: 200px;
            background: white;
            border-radius: 10px;
            padding: 18px 22px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .kpi-card .label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .kpi-card .value {
            font-size: 22px;
            font-weight: bold;
            color: #1a1a2e;
        }

        .table-wrapper {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow-x: auto;
            margin-bottom: 28px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 13.5px;
        }

        thead th {
            background: #1a1a2e;
            color: white;
            padding: 11px 12px;
            text-align: center;
            white-space: nowrap;
        }

        tbody td {
            border-bottom: 1px solid #eee;
            padding: 9px 12px;
            text-align: center;
        }

        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover { background: #f7f9fc; }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-under { background: #d4edda; color: #155724; }
        .badge-over  { background: #f8d7da; color: #721c24; }

        .chart-wrapper {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 24px;
            max-width: 600px;
        }
    </style>
</head>
<body>

<h2>‚úàÔ∏è Airline Revenue Management Dashboard</h2>

<div class="controls">
    <select id="flightSelect">
        <option value="">All Flights</option>
        {% for f in flights %}
            <option value="{{ f.flight_number }}">
                {{ f.flight_number }} ({{ f.origin }} ‚Üí {{ f.dest }})
            </option>
        {% endfor %}
    </select>

    <select id="classSelect">
        <option value="">All Classes</option>
        {% for c in classes %}
            <option value="{{ c }}">{{ c }}</option>
        {% endfor %}
    </select>

    <button onclick="loadData()">üîç Query</button>
    <button onclick="resetFilters()" style="background:#6c757d;">‚Ü© Reset</button>
</div>

<div class="kpi-row">
    <div class="kpi-card">
        <div class="label">Total Actual Revenue</div>
        <div class="value" id="totalActual">‚Äî</div>
    </div>
    <div class="kpi-card">
        <div class="label">Total Predicted Revenue</div>
        <div class="value" id="totalPredicted">‚Äî</div>
    </div>
    <div class="kpi-card">
        <div class="label">Total Incremental Revenue</div>
        <div class="value" id="totalIncremental">‚Äî</div>
    </div>
</div>

<div class="table-wrapper">
    <table id="resultsTable">
        <thead>
            <tr>
                <th>Flight</th>
                <th>Class</th>
                <th>Cabin</th>
                <th>Actual Bookings</th>
                <th>Predicted Bookings</th>
                <th>Error</th>
                <th>Actual Revenue</th>
                <th>Predicted Revenue</th>
                <th>Incremental Revenue</th>
                <th>Load Factor</th>
                <th>Demand Signal</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="11" id="emptyState">Select filters and click Query to load data.</td></tr>
        </tbody>
    </table>
</div>

<div class="chart-wrapper">
    <canvas id="revenueChart"></canvas>
</div>

<script>
let revenueChart;

function fmt(n) {
    return Number(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function loadData() {
    const flightVal = document.getElementById("flightSelect").value;
    const classCode = document.getElementById("classSelect").value;

    let url = `/api/predictions?limit=1000`;
    if (flightVal) url += `&flight_number=${flightVal}`;
    if (classCode) url += `&class_code=${classCode}`;

    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error("Network response was not ok");
            return response.json();
        })
        .then(data => {
            const tbody = document.querySelector("#resultsTable tbody");
            tbody.innerHTML = "";

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="11" id="emptyState">No results found for the selected filters.</td></tr>`;
                resetKPIs();
                return;
            }

            let totalActual = 0, totalPredicted = 0, totalIncremental = 0;

            data.forEach(row => {
                totalActual      += Number(row.actual_revenue)      || 0;
                totalPredicted   += Number(row.predicted_revenue)   || 0;
                totalIncremental += Number(row.incremental_revenue) || 0;

                const signal     = row.demand_signal || 'N/A';
                const badgeClass = signal === 'Underpriced' ? 'badge-under' : 'badge-over';
                const loadFactor = isNaN(row.load_factor_estimate)
                    ? 'N/A'
                    : (Number(row.load_factor_estimate) * 100).toFixed(1) + '%';

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${row.flight_number || 'N/A'}</td>
                    <td>${row.class_code    || 'N/A'}</td>
                    <td>${row.cabin_name    || 'N/A'}</td>
                    <td>${row.actual_final  || 0}</td>
                    <td>${Number(row.predicted_final).toFixed(0)}</td>
                    <td>${Number(row.error).toFixed(2)}</td>
                    <td>$${fmt(row.actual_revenue)}</td>
                    <td>$${fmt(row.predicted_revenue)}</td>
                    <td>$${fmt(row.incremental_revenue)}</td>
                    <td>${loadFactor}</td>
                    <td><span class="badge ${badgeClass}">${signal}</span></td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById("totalActual").innerText      = `$${fmt(totalActual)}`;
            document.getElementById("totalPredicted").innerText   = `$${fmt(totalPredicted)}`;
            document.getElementById("totalIncremental").innerText = `$${fmt(totalIncremental)}`;

            updateChart(totalActual, totalPredicted, totalIncremental);
        })
        .catch(err => {
            console.error("Error loading data:", err);
            alert("Failed to load data. Check the console for details.");
        });
}

function resetFilters() {
    document.getElementById("flightSelect").value = "";
    document.getElementById("classSelect").value  = "";
    document.querySelector("#resultsTable tbody").innerHTML =
        `<tr><td colspan="11" id="emptyState">Select filters and click Query to load data.</td></tr>`;
    resetKPIs();
    if (revenueChart) { revenueChart.destroy(); revenueChart = null; }
}

function resetKPIs() {
    document.getElementById("totalActual").innerText      = "‚Äî";
    document.getElementById("totalPredicted").innerText   = "‚Äî";
    document.getElementById("totalIncremental").innerText = "‚Äî";
}

function updateChart(actual, predicted, incremental) {
    const ctx = document.getElementById('revenueChart');
    if (revenueChart) revenueChart.destroy();

    revenueChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Actual Revenue', 'Predicted Revenue', 'Incremental Revenue'],
            datasets: [{
                label: 'Revenue ($)',
                data: [actual, predicted, incremental],
                backgroundColor: ['#4e79a7', '#f28e2b', '#59a14f'],
                borderRadius: 6,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => ` $${fmt(ctx.raw)}`
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: val => '$' + val.toLocaleString()
                    }
                }
            }
        }
    });
}
</script>

</body>
</html>